<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect Wallet - ENVXX MCP AURA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@coinbase/wallet-sdk@4.0.4/dist/index.umd.js"></script>
    <style>
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #10b981;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
        <div class="container mx-auto px-4 py-8">
            <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-6">
                <div class="text-center mb-8">
                    <h1 class="text-2xl font-bold text-gray-900 mb-2">
                        ðŸ”— Connect Your Wallet
                    </h1>
                    <p class="text-gray-600">
                        Connect your wallet to sign DeFi transactions securely
                    </p>
                </div>

                <div class="space-y-4">
                    <button onclick="connectWallet('metamask')"
                            id="metamask-btn"
                            class="w-full flex items-center justify-center px-4 py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-medium transition-colors">
                        <span id="metamask-text">
                            <img src="https://metamask.io/images/metamask-logo.png" alt="MetaMask" class="w-6 h-6 mr-3 inline" style="filter: brightness(0) invert(1);" />
                            Connect MetaMask
                        </span>
                    </button>

                    <button onclick="connectWallet('coinbase')"
                            id="coinbase-btn"
                            class="w-full flex items-center justify-center px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
                        <span id="coinbase-text">
                            <img src="https://www.coinbase.com/img/coinbase-wallet-logo.png" alt="Coinbase Wallet" class="w-6 h-6 mr-3 inline" />
                            Coinbase Wallet
                        </span>
                    </button>

                    <button onclick="connectWallet('walletconnect')"
                            id="walletconnect-btn"
                            class="w-full flex items-center justify-center px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors">
                        <span id="walletconnect-text">
                            <img src="https://walletconnect.com/images/walletconnect-logo.png" alt="WalletConnect" class="w-6 h-6 mr-3 inline" style="filter: brightness(0) invert(1);" />
                            WalletConnect
                        </span>
                    </button>
                </div>

                <div id="account-info" class="mt-6 p-4 bg-green-50 rounded-lg hidden">
                    <h3 class="font-medium text-green-900 mb-2">Connected Account</h3>
                    <p id="account-address" class="text-sm text-green-700 font-mono break-all"></p>
                    <p id="account-balance" class="text-sm text-green-600 mt-1"></p>
                </div>

                <div class="mt-6 text-center">
                    <p class="text-sm text-gray-500">
                        Secure connection powered by ENVXX MCP AURA
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get actionId from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const actionId = urlParams.get('actionId') || 'unknown';

        let provider;
        let signer;
        let connectedWallet = null;

        // Initialize Coinbase Wallet SDK
        let coinbaseWalletSDK;
        try {
            coinbaseWalletSDK = new CoinbaseWalletSDK({
                appName: 'ENVXX MCP AURA',
                appLogoUrl: 'https://mcp-aura.vercel.app/favicon.ico',
                darkMode: false
            });
        } catch (error) {
            console.warn('Coinbase Wallet SDK not available:', error);
        }

        async function connectWallet(walletType) {
            // Disable all buttons
            const buttons = ['metamask-btn', 'walletconnect-btn', 'coinbase-btn'];
            buttons.forEach(btnId => {
                document.getElementById(btnId).disabled = true;
            });

            // Show loading state for clicked button
            const buttonTextId = walletType + '-text';
            document.getElementById(buttonTextId).innerHTML = '<div class="spinner mr-3"></div> Connecting...';

            try {
                let accounts = [];
                let balance = '0';

                switch (walletType) {
                    case 'metamask':
                        if (typeof window.ethereum !== 'undefined') {
                            // Request account access
                            accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });

                            // Create ethers provider
                            provider = new ethers.providers.Web3Provider(window.ethereum);
                            signer = provider.getSigner();

                            // Get balance
                            const balanceWei = await provider.getBalance(accounts[0]);
                            balance = ethers.utils.formatEther(balanceWei);

                        } else {
                            throw new Error('MetaMask not installed. Please install MetaMask extension.');
                        }
                        break;

                    case 'coinbase':
                        if (coinbaseWalletSDK) {
                            const coinbaseProvider = coinbaseWalletSDK.makeWeb3Provider('https://mainnet.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161', 1);
                            accounts = await coinbaseProvider.request({ method: 'eth_requestAccounts' });
                            provider = new ethers.providers.Web3Provider(coinbaseProvider);
                            signer = provider.getSigner();

                            const balanceWei = await provider.getBalance(accounts[0]);
                            balance = ethers.utils.formatEther(balanceWei);
                        } else {
                            throw new Error('Coinbase Wallet not available');
                        }
                        break;

                    case 'walletconnect':
                        // WalletConnect would need more setup, for now show message
                        throw new Error('WalletConnect integration coming soon');
                        break;

                    default:
                        throw new Error('Unsupported wallet type');
                }

                connectedWallet = walletType;

                // Show connected account info
                document.getElementById('account-info').classList.remove('hidden');
                document.getElementById('account-address').textContent = accounts[0];
                document.getElementById('account-balance').textContent = `Balance: ${parseFloat(balance).toFixed(4)} ETH`;

                // Store connection info for next page
                localStorage.setItem('wallet_connected', 'true');
                localStorage.setItem('wallet_type', walletType);
                localStorage.setItem('wallet_address', accounts[0]);

                // Success message
                alert(`Successfully connected to ${walletType.toUpperCase()}! ðŸŽ‰`);

                // Redirect to signing page after 2 seconds
                setTimeout(() => {
                    if (actionId && actionId !== 'unknown') {
                        window.location.href = `/wallet/sign.html?actionId=${actionId}`;
                    }
                }, 2000);

            } catch (error) {
                console.error('Wallet connection failed:', error);
                alert(`Wallet connection failed: ${error.message}`);

                // Re-enable buttons
                buttons.forEach(btnId => {
                    document.getElementById(btnId).disabled = false;
                });
                // Reset button text
                document.getElementById(buttonTextId).innerHTML = getButtonText(walletType);
            }
        }

        function getButtonText(walletType) {
            const texts = {
                metamask: '<img src="https://metamask.io/images/metamask-logo.png" alt="MetaMask" class="w-6 h-6 mr-3 inline" style="filter: brightness(0) invert(1);" /> Connect MetaMask',
                walletconnect: '<img src="https://walletconnect.com/images/walletconnect-logo.png" alt="WalletConnect" class="w-6 h-6 mr-3 inline" style="filter: brightness(0) invert(1);" /> WalletConnect',
                coinbase: '<img src="https://www.coinbase.com/img/coinbase-wallet-logo.png" alt="Coinbase Wallet" class="w-6 h-6 mr-3 inline" /> Coinbase Wallet'
            };
            return texts[walletType] || walletType;
        }

        // Check if already connected
        window.onload = function() {
            const isConnected = localStorage.getItem('wallet_connected');
            if (isConnected) {
                const walletType = localStorage.getItem('wallet_type');
                const address = localStorage.getItem('wallet_address');

                if (address) {
                    document.getElementById('account-info').classList.remove('hidden');
                    document.getElementById('account-address').textContent = address;
                    document.getElementById('account-balance').textContent = 'Balance: Loading...';
                }
            }
        };
    </script>
</body>
</html>
